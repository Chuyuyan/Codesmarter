<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - SmartCursor</title>
    <link rel="stylesheet" href="/static/css/auth.css">
    <link rel="stylesheet" href="/static/css/language-selector.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Reset Password</h1>
                <p>Enter your email to receive a password reset link</p>
            </div>

            <form id="forgotPasswordForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        placeholder="your.email@example.com"
                        required
                        autocomplete="email"
                    >
                    <span class="error-message" id="emailError"></span>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="btn-text">Send Reset Link</span>
                    <span class="btn-loader" style="display: none;">⏳</span>
                </button>

                <div class="auth-message" id="authMessage"></div>
            </form>

            <div class="auth-footer">
                <p>Remember your password? <a href="/login">Sign in</a></p>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        // Forgot password form handler
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                clearError('emailError');
                
                const email = document.getElementById('email').value.trim();
                
                if (!email) {
                    showError('emailError', 'Email is required');
                    return;
                }
                
                if (!validateEmail(email)) {
                    showError('emailError', 'Please enter a valid email address');
                    return;
                }
                
                setLoading(forgotPasswordForm, true);
                
                try {
                    console.log('[forgot-password] Requesting password reset for:', email);
                    const result = await apiCall('/auth/forgot-password', {
                        method: 'POST',
                        body: JSON.stringify({ email: email })
                    });
                    
                    console.log('[forgot-password] Response:', result);
                    
                    if (result.ok && result.data && result.data.ok) {
                        // Always show success message
                        showMessage(result.data.message || 'If an account with that email exists, a password reset link has been sent.', 'success');
                        
                        // Show development info
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'auth-message';
                        infoDiv.style.marginTop = '10px';
                        infoDiv.style.padding = '15px';
                        infoDiv.style.backgroundColor = '#f0f0f0';
                        infoDiv.style.borderRadius = '6px';
                        infoDiv.style.fontSize = '14px';
                        
                        let infoHtml = '';
                        
                        if (result.data.email_sent) {
                            infoHtml += '<p style="color: green; margin: 5px 0;">✓ Email sent successfully</p>';
                        }
                        if (result.data.sms_sent) {
                            infoHtml += '<p style="color: green; margin: 5px 0;">✓ SMS sent successfully</p>';
                        }
                        if (!result.data.email_sent && !result.data.sms_sent) {
                            infoHtml += '<p style="color: orange; margin: 5px 0;">⚠ Email/SMS not configured - using development mode</p>';
                        }
                        
                        // Always show token in development mode
                        if (result.data.token || result.data.reset_url) {
                            const token = result.data.token || result.data.reset_url.split('token=')[1];
                            const resetUrl = result.data.reset_url || `/reset-password?token=${token}`;
                            
                            infoHtml += `
                                <div style="margin-top: 10px;">
                                    <strong>Development Mode - Reset Link:</strong><br>
                                    <a href="${resetUrl}" style="color: #667eea; text-decoration: underline; word-break: break-all; display: inline-block; margin-top: 5px;">
                                        ${resetUrl}
                                    </a>
                                </div>
                            `;
                        }
                        
                        if (infoHtml) {
                            infoDiv.innerHTML = infoHtml;
                            forgotPasswordForm.appendChild(infoDiv);
                        }
                    } else {
                        const errorMsg = result.data?.error || result.error || 'Failed to send reset link';
                        console.error('[forgot-password] Error:', errorMsg);
                        showMessage(errorMsg, 'error');
                    }
                } catch (error) {
                    console.error('[forgot-password] Exception:', error);
                    showMessage('Network error. Please check if the server is running.', 'error');
                } finally {
                    setLoading(forgotPasswordForm, false);
                }
            });
        }
    </script>
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/language-selector.js"></script>
</body>
</html>

